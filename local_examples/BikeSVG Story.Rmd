---
title: "BikeSGV Story"
output:
  html_document:
    df_print: paged
---

Using a just few synoptic and time series data functions, we can investigate 
something fishy going on with one particular air monitor in northwest Pasadena.

Let's pull it up by it monitor label, *BikeSGV - West Pasadena*, from a loaded 
list of US PurpleAir monitors:

```{r setup}
library(AirSensor)

pas <- pas_load()
pas_bikesgv <- pas_filter(pas, label == "BikeSGV - West Pasadena")
pas_leaflet(pas_bikesgv)
```

While this surface level glance may seem normal at first, the monitor's past
measurements happen to display something very strange. We can gather these 
readings by loading a PurpleAir Timeseries *pat* object using the same label:

```{r load_time_series, warning=FALSE}
pat_bikesgv <- pat_loadLatest(pas, "BikeSGV - West Pasadena", 
                              startdate="2019-06-18", enddate="2019-06-25")
pat_multiplot(pat_bikesgv)
```

This monitor's A and B sensor channels appear to be telling us two 
completely different stories! Let's zoom in on just the PM readings for now and
overlay them by setting the plottype:

```{r plot_multi, warning=FALSE}
pat_multiplot(pat_bikesgv, plottype = "pm25_over")
```

While the A channel PM 2.5 measurements oscillate over time in a fairly natural 
manner, they also all measure impossibly high: Around 4000 μg/m³ when 
anything over 100 μg/m³ on the 
[AQI](https://www.airnow.gov/index.cfm?action=aqibasics.aqi) is unhealthy! This 
also skews the plot enough to make the B channel look practically flat, so let's
separate them and take a look at B on its own scale to see if it's readings are 
more reasonable:

```{r plot_pm25_overlay, warning=FALSE}
pm25_b <- sampled_b[, c("datetime", "pm25_B")]
plot(pm25_b, type = "p", main = "PM 2.5 Channel B", cex = 0.5, pch=15, col=adjustcolor("black", 0.2),
     xlab = "Date", ylab = "PM 2.5 (ug/m3)")
```

B channel does look a bit more normal, with just a few spikes here and there never 
reaching ridiculous levels like channel A.
So what *is* the issue with channel A then? Is there any relationship between the channels 
at all? Let's generate a linear fit between them and see if maybe they are 
scaled versions of each other:

```{r channel_comparison, warning=FALSE, message=FALSE, error=FALSE}
pat_internalFit(pat_bikesgv)
```

(Correlation plot is too small to analyze).

It looks like the A ad B channels aren't linearly correlated at all. This is 
odd since, ideally, the two sensors should measure exactly the same or at least very 
similar. Maybe comparing with another sensor could give us some insight. We can 
check them all against each other at once using a scatterplot:

```{r sensor_scatterplot, warning=FALSE, message=FALSE}
pat_scatterplot(pat_bikesgv)
```

Now we're getting somewhere! While the correlation plot between the two channels is a 
shapeless cloud, channel A seems to have a very well defined relationship with 
temperature and humidity while channel B has no similarities with them at all.

How closely related is channel A to these auxilary sensors though? Let's first make 
a linear model between the channel A and temperature:

```{r pm25a_and_temp, warning=FALSE}
pat_data <- pat_bikesgv$data
model_temp <- lm(temperature ~ pm25_A, data=pat_data)

par(mfrow = c(2, 2), las = 1)
plot(model_temp)
summary(model_temp)
```

That's a pretty clear linear correlation! I wonder how closely the line
graphs would match if we scaled the A channel readings down by applying the
linear model coefficients?

```{r sca}
x <- pat_data$datetime
y <- pat_data$temperature
scaled_pm25a <- predict.lm(model_temp, newdata=pat_data)

par(las = 1)
plot(x, y, 
     col = "cornflowerblue", lwd = 5, lty = "solid", type = "l", 
     main = "Scaling PM2.5_A to Temperature",
     xlab = "Date", ylab = "Temperature (F)")
lines(x, scaled_pm25a, col = "black", lwd = 1)
```

Wow! Although it's a bit noisy, the A channel definitely matches the general shape of
the temperature plot! Let's see if the same holds when comparing to humidity:

```{r}
model_humid <- lm(humidity ~ pm25_A, data=pat_data)
x <- pat_data$datetime
y <- pat_data$humidity
scaled_a <- predict.lm(model_humid, newdata=pat_data)

par(las = 1)
plot(x, y, 
     col = "cornflowerblue", lwd = 5, lty = "solid", type = "l", 
     main = "Scaling PM2.5_A to Humidity",
     xlab = "Date", ylab = "Temperature (F)")
lines(x, scaled_a, col = "black", lwd = 1)
```

Maybe not quite as definite as the temperature comparison, but once again the 
channel A readings match the trend of the humidity data. Just to be complete, let's
try the same comparson process using the channel B PM 2.5 readings and see if
we find a relationship:

```{r}
model_temp_b <- lm(temperature ~ pm25_B, data=pat_data)
x <- pat_data$datetime
y <- pat_data$temperature
scaled_b <- predict.lm(model_temp_b, newdata=pat_data)

par(las = 1)
plot(x, y, 
     col = "cornflowerblue", lwd = 5, lty = "solid", type = "l", 
     main = "Scaling PM2.5_B to Temperature",
     xlab = "Date", ylab = "Temperature (F)")
lines(x, scaled_b, col = "black", lwd = 1)
```

Hmm, not at all.
So what is happening with channel A? It almost seems like the
temperature or humidity readings have been leaking into the PM 2.5 channel A sensor
and overriding its measurements (if it's still taking any).

So far though we've only looked at a week's worth of questionable data. Has this
monitor always been acting this way? Lets load and view readings from earlier 
this year:

```{r warning=FALSE}
pat_bikesgv <- pat_loadLatest(pas, "BikeSGV - West Pasadena", 
                              startdate="2019-04-05", enddate="2019-04-22")

pat_dygraph(pat_bikesgv)
```

That answers that question! Before the evening of April 18th, 2019, both 
channels seemed to agree with each other. Around 7:00 PM though, channel A 
suddenly switched to the strange state we investigated originally.
Channel A also appeared to have some issues between April 7th and 9th which
yielded readings in the same 3000-4000 μg/m³ range, but returned to normal for 
about a week before going bonkers again.

Channel B seemed unaffected by anything the whole time though. Let's see if 
the auxilary sensors experienced anything unusual:

```{r}
pat_multiplot(pat_bikesgv)
```

Doesn't look like it. Just PM 2.5 channel A cha

...incomplete...
TODO: Maybe display a couple other monitors' scatterplots to see where we should
find relationships and where we shouldn't.

THE END
