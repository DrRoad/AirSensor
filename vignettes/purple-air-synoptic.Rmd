---
title: "Working with Synoptic Data from Purple Air"
author: "Ruby Fore"
date: "2019-1-30"
output:
  html_document:
    toc: TRUE
vignette: >
  %\VignetteIndexEntry{purple-air-synoptic}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=5)
```

# Background

JON: For Jon to write.

# Obtaining synoptic data from Puple Air

What is synoptic data

Synoptic means 'relating to or displaying conditions (as of the atmosphere or weather) as they exist simultaneously over a broad area'. Synoptic PurpleAir data is from all (or multiple) PurpleAir sensors at one point in time, and is contrasted with timeseries data, which is from a single sensor over multiple timepoints. 

## raw data from Purple Air

In the **MazamaPurpleAir** package the primary function to download synoptic data is `pas_load()`. This function downloads data in JSON format from https://www.purpleair.com/json, replaces variable names with human readable ones, formats data to make things easy in R, and adds columns with geographic information (spatial metadata) for each sensor. 

`pas_load()` is a wrapper for two other functions in **MazamaPurpleAir** -  `downloadParseSynopticData()`, which performs the data acquisition step, and `enhanceSynopticData()`, which performs the data tidying and addition of the spatial metadata. 


Let's take a look at what `pas_load()` returns by examining a pre-loaded dataset in the *MazamaPurpleAir* package, or by downloading your own. 

```{r pas_objects, message=FALSE}
# loading MazamaPurpleAir 
library(MazamaPurpleAir)
# and MazamaSpatialUtils
library(MazamaSpatialUtils)

# Load package data
data("example_pas")

# Code to download new data
# pas <- pas_load()
```

Now we can look at the class, dimensions and column names of the object named `pas`. 

```{r examining_pas}
class(example_pas)
dim(example_pas)
```

Note that in addition to being a `data.frame` and `tibble`, pas is a `pa_synoptic` object. 

We can also examine the column names, which are delivered by `pas_load()` as neat and easy-to-read names. 

```{r column_names}
colnames(example_pas)
```

functions to get it
what does it look like
...

## "spatially enhanced metadata"

what do we mean by this
how will we do it -- MazamaSpatialUtils
functions to enhnance
what columns are added
what will we eventually be able to do with them

Metadata is data that gives information about other data. When working with PurpleAir data, we think of the sensor readings of air quality as the primary data of interest, and data about the sensors themselves as metadata. The raw data contains sensors' names, ID numbers as well as latitude and longitude coordinates of the sensors' locations. 

Latitude and longitude coordinates are extremely useful pieces of information, and great for mapping, but they are hard to interpret for the average human. However, using the **MazamaSpatialUtils** package, coordinate information can be used to add a new column classifying each Purple Air sensor by state, country and timezone. This is performed by the `enhanceSynopticData()` function. 

In addition to spatial information regarding administrative boundaries and time, the `enhanceSynopticData()` function adds two columns entitled `pwfsl_closestDistance` and `pwfsl_closestMonitorID`. 

All of these columns are now options for subsetting the data, using functionality imported from **dply** and **magrittr**

# working with a "spatially enhanced" *pas* object

tour of functionality


The **MazamaPurpleAir** package incorporates functionality from **dplyr** and **magrittr** to make data analysis easier and the corresponding code more readable. The functions imported are the piping function from **magrittr** (`%>%`) and `filter()` from **dplyr**. 

Lets demonstrate this functionality by looking at only West Coast sensors, i.e. sensors with a state code of WA, OR, or CA. 


```{r subsetting}
# subsetting using piping and filter() from magrittr and dplyr, respecively
WestCoast_pas <- example_pas %>%
  filter(stateCode %in% c('OR', 'WA', 'CA'))
# And plotting to check what the result is 
pas_leaflet(WestCoast_pas)
```


That is still a lot of sensors! We might want to check how far these sensors are from a PWFSL monitor, which is an easy graph based on the `pwfsl_closestDistance` column. 

```{r histogram}
hist(WestCoast_pas$pwfsl_closestDistance, n=50)
```


The units for `pwfsl_closestDistance` are meters, so some of these Purple Air sensors are extremely far away from the nearest PWFSL monitor. This is one great thing about the Purple Air data - there is much greater measurement density. But 20,000 meters is about 12 miles, and atmospheric conditions can vary a lot across twelve miles!

Let's take a look at sensors that are within a mile, or approximately 16000 meters, by subsetting the data again. 

```{r subsetting-2}
# subset 
WestCoast_pas <- WestCoast_pas %>%
  filter(pwfsl_closestDistance <= 16009)
# and plot 
pas_leaflet(WestCoast_pas)
```

In the new plot, we can start to see some clumps of Purple Air sensors in cities, especially San Francisco and Sacramento, as well as Eugene, OR. 

To work more with Purple Air and PWFSL data together, check out the vignettes for the **PWFSLSmoke** package as well as the **MazamaPurpleAir** time series data vignette. 




