---
title: "An Introduction to PurpleAir Timeseries Data"
author: "Mazama Science"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Maps and Timeseries Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=5)
library(MazamaCoreUtils)
library(MazamaPurpleAir)
library(dplyr)
library(ggplot2)
# NOTE: Use example PAS and PAT data for vignettes to avoid long wait-times
data("example_pas")
data("example_pat")
pas <- example_pas
pat <- example_pat
```

_Timeseries_ data provides a minute-by-minute database structure for transforming 
and analyzing [PurpleAir](https://www.purpleair.com/) sensor data.
This vignette demonstrates an example analysis of an individual monitor located
in Seattle, Washington over a two-month duration in which the Pacific Northwest 
experienced [hazardous air-quality conditions](https://www.usnews.com/news/healthiest-communities/articles/2018-08-19/air-quality-to-worsen-in-northwest-as-smoke-returns) caused by wildfires in British Columbia, Canada. 

**Note:** It is highly recommended that you read `vignettes/pas_introduction.Rmd`
before beginning this tutorial.

### Loading PurpleAir Timeseries data
PurpleAir sensor readings are uploaded to the cloud every 80 seconds or so 
where they are stored for download and display on the PurpleAir website. After
every interval, the synoptic data is refreshed and the outdated synoptic data is 
then stored in a [ThingSpeak](https://thingspeak.com) database. In order to 
access the ThingSpeak channel API we must first load the synoptic dataset, which 
provides access tokens for each PurpleAir sensor -- accessed by the monitor of 
interests label. 

```{r, eval = FALSE}
library(MazamaPurpleAir)
library(MazamaCoreUtils)
pas <- pas_load()
pat <- pat_load(pas, "Seattle", startdate = 20180701, enddate = 20180901)
```


### PurpleAir Timeseries Data 
Let's begin by exploring the attributes of the dataframe returned by the 
`pat_load` function. 

```{r}
pat %>%
  attributes()
```

```{r}
pat$meta %>% 
  names()
```

```{r}
pat$data %>% 
  names()
```

```{r}
### TEST HAMPEL DETECTION!

x <- c(1,2,32,4,1,4,7,3,4,5,6,73,4,6,8,4,3,1,1,2,3,56,3,2,4)

hampel <- function(x, win = 6, sigma = 2) { 
  index <- x[1:(win+1)]
  ifelse( index >= sigma*sd(index), TRUE, FALSE )
  }
```



### Exploring Timeseries Data