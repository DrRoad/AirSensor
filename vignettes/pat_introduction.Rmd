---
title: "An Introduction to PurpleAir Time Series Data"
author: "Mazama Science"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Maps and Time series Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=5)
library(MazamaPurpleAir)
library(dplyr)
library(ggplot2)
# NOTE: Use example PAS and PAT data for vignettes to avoid long wait-times
data("example_pas")
data("example_pat")
pas <- example_pas
pat <- example_pat
```

_Time series_ data provides a minute-by-minute database structure for transforming 
and analyzing [PurpleAir](https://www.purpleair.com/) sensor data.
This vignette demonstrates an example analysis of an individual monitor located
in Seattle, Washington over a two-month duration in which the Pacific Northwest 
experienced [hazardous air-quality conditions](https://www.usnews.com/news/healthiest-communities/articles/2018-08-19/air-quality-to-worsen-in-northwest-as-smoke-returns) caused by wildfires in British Columbia, Canada. 

**Disclaimer:** It is highly recommended that you read `vignettes/pas_introduction.Rmd`
before beginning this tutorial.

### Installing spatial data
Before working with Purple Air time series data we have to download and install
datasets needed by the **MazamaSpatialUtils** package to assign timezone and 
other spatial  metadata to each sensor location. This operation only needs to be 
done once.

```{r installSpatialData, eval = FALSE}
library(MazamaSpatialUtils)
setSpatialDataDir('~/Data/Spatial')
installSpatialData()
```

### Loading PurpleAir Time Series data
PurpleAir sensor readings are uploaded to the cloud every 80 seconds or so 
where they are stored for download and display on the PurpleAir website. After
every interval, the synoptic data is refreshed and the outdated synoptic data is 
then stored in a [ThingSpeak](https://thingspeak.com) database. In order to 
access the ThingSpeak channel API we must first load the synoptic database, 
which contains identifiers and access tokens for each PurpleAir sensor. 

```{r, eval = FALSE}
library(MazamaSpatialUtils)
library(MazamaPurpleAir)
library(dplyr)
library(ggplot2)

initializeMazamaSpatialUtils()

pas <- pas_load()
pat <- pat_load(pas, "Seattle", startdate = 20180701, enddate = 20180901)
```

Notice when passing our synoptic dataframe "`pas`" to `pat_load()`, we also 
supply a unique identifier and date-interval. In this case, our 
monitor-of-interest (MOI) is a sensor named "Seattle" and our dates-of-interest
(DOI) is 2018-07-01 to 2018-09-01. (Dates are interpreted as UTC.)

**Note:** You must provide a label to `pat_load()` in 
order to supply ThingSpeak with the necessary metadata to access the sensors 
database. A DOI on the other hand is optional; by default not providing 
`pat_load()` with a start and end date will return exactly 1-week of time series 
data.

### PurpleAir Time Series Data
Let's begin by exploring the attributes of the dataframe returned by the 
`pat_load()` function. 

```{r}
pat %>%
  names()
```

`pat` contains _two_ dataframes, `meta` and `data`. 

By convention `meta` contains metadata for the selected PurpleAir sensor -- 
this includes non-time series data such as location information, labels, *etc.* 
The time series `data` contains time-interval PurpleAir sensor readings of 
PM2.5, temperature, humidity, and other pertinent sensor data. 

We can quickly display the raw time series data using `pat_multiplot()`
```{r}
pat_multiplot(pat = pat, plottype = "pm25")
```
```{r}
pat_multiplot(pat = pat, plottype = "aux")
```
```{r}
pat_multiplot(pat = pat, plottype = "all")
```

### Exploring Time Series Data